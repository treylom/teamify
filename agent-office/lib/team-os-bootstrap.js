#!/usr/bin/env node
/**
 * Team OS Bootstrap — Auto-scaffolding script
 *
 * Creates the full .team-os/ directory structure when it doesn't exist.
 * Can be run standalone: node agent-office/lib/team-os-bootstrap.js
 * Or via API: POST /api/team-os/bootstrap
 */

const fs = require('fs');
const path = require('path');

function bootstrapTeamOS(projectRoot, { repair = false } = {}) {
  const teamOSDir = path.join(projectRoot, '.team-os');
  const report = { created: [], skipped: [], repaired: [], errors: [] };

  const registryExists = fs.existsSync(path.join(teamOSDir, 'registry.yaml'));

  // Full bootstrap: registry가 없으면 전체 생성
  // Repair mode: registry가 있어도 누락 파일만 생성
  if (registryExists && !repair) {
    report.skipped.push('registry.yaml already exists — use repair mode to fix missing files');
    return report;
  }

  // Create directories
  const dirs = [
    '',
    'spawn-prompts',
    'artifacts',
    'artifacts/findings',
    'artifacts/findings/ingest',
    'artifacts/findings/analyze',
    'artifacts/findings/graph',
    'artifacts/findings/storage',
    'hooks',
    'consensus',
  ];

  for (const dir of dirs) {
    const fullPath = path.join(teamOSDir, dir);
    if (!fs.existsSync(fullPath)) {
      fs.mkdirSync(fullPath, { recursive: true });
      report.created.push(dir || '.team-os/');
    }
  }

  // Create files
  const files = {
    'registry.yaml': TEMPLATE_REGISTRY,
    'spawn-prompts/graph-navigator.md': TEMPLATE_SPAWN_GRAPH_NAV,
    'spawn-prompts/retrieval-specialist.md': TEMPLATE_SPAWN_RETRIEVAL,
    'spawn-prompts/deep-reader.md': TEMPLATE_SPAWN_DEEP_READER,
    'spawn-prompts/content-analyzer.md': TEMPLATE_SPAWN_CONTENT_ANALYZER,
    'spawn-prompts/link-curator.md': TEMPLATE_SPAWN_LINK_CURATOR,
    'artifacts/TEAM_PLAN.md': TEMPLATE_TEAM_PLAN,
    'artifacts/TEAM_BULLETIN.md': TEMPLATE_TEAM_BULLETIN,
    'artifacts/TEAM_PROGRESS.md': TEMPLATE_TEAM_PROGRESS,
    'artifacts/TEAM_FINDINGS.md': TEMPLATE_TEAM_FINDINGS,
    'artifacts/MEMORY.md': TEMPLATE_MEMORY,
    'hooks/teammate-idle-gate.js': TEMPLATE_HOOK_IDLE,
    'hooks/task-completed-gate.js': TEMPLATE_HOOK_COMPLETED,
    'consensus/000-template.md': TEMPLATE_CONSENSUS,
  };

  for (const [relPath, content] of Object.entries(files)) {
    const fullPath = path.join(teamOSDir, relPath);
    try {
      if (!fs.existsSync(fullPath)) {
        fs.writeFileSync(fullPath, content, 'utf-8');
        if (repair) {
          report.repaired.push(relPath);
        } else {
          report.created.push(relPath);
        }
      } else {
        report.skipped.push(relPath);
      }
    } catch (e) {
      report.errors.push(`${relPath}: ${e.message}`);
    }
  }

  // Create .gitkeep files
  const gitkeeps = [
    'artifacts/findings/ingest/.gitkeep',
    'artifacts/findings/analyze/.gitkeep',
    'artifacts/findings/graph/.gitkeep',
    'artifacts/findings/storage/.gitkeep',
  ];

  for (const relPath of gitkeeps) {
    const fullPath = path.join(teamOSDir, relPath);
    if (!fs.existsSync(fullPath)) {
      fs.writeFileSync(fullPath, '', 'utf-8');
    }
  }

  return report;
}

// === Templates ===

const TEMPLATE_REGISTRY = `# Team OS Registry - Knowledge Manager Agent Teams
# Version: 1.0.0
# Auto-generated by team-os-bootstrap.js

version: 1

defaults:
  routing_policy:
    opus:
      use_for: ["architecture", "consensus", "cross-validation", "complex-analysis"]
    sonnet:
      use_for: ["implementation", "exploration", "summarization", "coordination"]
    haiku:
      use_for: ["classification", "tagging", "triage", "simple-search"]

  hooks:
    teammate_idle: ".team-os/hooks/teammate-idle-gate.js"
    task_completed: ".team-os/hooks/task-completed-gate.js"

  ralph_loop:
    default: false
    max_iterations: 2
    evaluation_criteria:
      graph-navigator: "Hub notes >= 2, related notes >= 5"
      retrieval-specialist: "keyword matches >= 10, tag matches >= 3"
      deep-reader: "cross-analysis items >= 3"
      content-analyzer: "structure proposal included, tag recommendations included"
      link-curator: "relevance score 3+ >= 3"

  artifacts_root: ".team-os/artifacts"
  consensus_root: ".team-os/consensus"
  spawn_prompts_root: ".team-os/spawn-prompts"

  shared_memory:
    layer1_markdown:
      team_plan: ".team-os/artifacts/TEAM_PLAN.md"
      team_bulletin: ".team-os/artifacts/TEAM_BULLETIN.md"
      team_progress: ".team-os/artifacts/TEAM_PROGRESS.md"
      team_findings: ".team-os/artifacts/TEAM_FINDINGS.md"
      team_memory: ".team-os/artifacts/MEMORY.md"
      session_init:
        reset: ["team_plan", "team_bulletin", "team_progress", "team_findings"]
        preserve: ["team_memory"]

  agent_memory_protocol:
    before_work:
      - "Read TEAM_PLAN.md"
      - "Read TEAM_BULLETIN.md"
    during_work:
      - "Append to TEAM_BULLETIN.md"
      - "Update TEAM_PROGRESS.md"
    after_work:
      - "Summarize in TEAM_FINDINGS.md"

complexity_mapping:
  Simple:
    agents: 0
    description: "Main solo"
    teams: []

  Standard:
    agents: 2
    description: "Graph search + keyword search parallel"
    teammates:
      - { name: graph-navigator, model: sonnet, subagent_type: Explore, spawn_prompt: graph-navigator.md }
      - { name: retrieval-specialist, model: sonnet, subagent_type: Explore, spawn_prompt: retrieval-specialist.md }

  Complex:
    agents: 5
    description: "Full team: graph + retrieval + deep-read + analyze + link-curate"
    teammates:
      - { name: graph-navigator, model: sonnet, subagent_type: Explore, spawn_prompt: graph-navigator.md }
      - { name: retrieval-specialist, model: sonnet, subagent_type: Explore, spawn_prompt: retrieval-specialist.md }
      - { name: deep-reader, model: sonnet, subagent_type: Explore, spawn_prompt: deep-reader.md }
      - { name: content-analyzer, model: sonnet, subagent_type: general-purpose, spawn_prompt: content-analyzer.md }
      - { name: link-curator, model: haiku, subagent_type: Explore, spawn_prompt: link-curator.md }
`;

const TEMPLATE_SPAWN_GRAPH_NAV = `# Graph Navigator Spawn Prompt

You are **graph-navigator**, a Wikilink graph traversal specialist.

## Mission
Explore the Obsidian vault's [[wikilink]] graph to find notes related to: **{{TOPIC}}**

## Method
1. Start from known hub notes (MOC files, index notes)
2. Follow [[wikilinks]] 1-hop and 2-hop deep
3. Track the relationship graph
4. Identify hub notes (high connectivity)

## Output
Report your findings to TEAM_BULLETIN.md:
- Hub notes found (with link count)
- 1-hop connections
- 2-hop discoveries
- Relationship map summary

## Rules
- READ ONLY - do not modify any vault files
- Read TEAM_BULLETIN.md before starting
- Append your findings to TEAM_BULLETIN.md when done
`;

const TEMPLATE_SPAWN_RETRIEVAL = `# Retrieval Specialist Spawn Prompt

You are **retrieval-specialist**, a broad keyword and tag search expert.

## Mission
Search the entire vault for content related to: **{{TOPIC}}**

## Method
1. Grep for topic keywords across all .md files
2. Search by relevant tags
3. Check folder distribution
4. Find isolated notes (no wikilinks to topic)

## Output
Report your findings to TEAM_BULLETIN.md:
- Keyword matches (top 20)
- Tag matches
- Folder distribution
- Isolated but relevant notes

## Rules
- READ ONLY - do not modify any vault files
- Read TEAM_BULLETIN.md before starting
- Append your findings to TEAM_BULLETIN.md when done
`;

const TEMPLATE_SPAWN_DEEP_READER = `# Deep Reader Spawn Prompt

You are **deep-reader**, a thorough content analyst.

## Mission
Read the top hub notes identified by graph-navigator and provide deep analysis of: **{{TOPIC}}**

## Method
1. Read each hub note fully (not just headers)
2. Extract key concepts, arguments, evidence
3. Cross-reference between notes
4. Identify knowledge gaps

## Output
Report to TEAM_BULLETIN.md:
- Summary per hub note
- Cross-analysis (common themes, contradictions, gaps)
- Recommended note structure for new content

## Rules
- READ ONLY - do not modify any vault files
- Wait for graph-navigator results if needed
`;

const TEMPLATE_SPAWN_CONTENT_ANALYZER = `# Content Analyzer Spawn Prompt

You are **content-analyzer**, a content structuring specialist.

## Mission
Analyze extracted content and propose optimal note structure for: **{{TOPIC}}**

## Method
1. Analyze content from ingest phase
2. Propose note hierarchy (MOC + sub-notes)
3. Recommend tags and categories
4. Design YAML frontmatter

## Output
Write analysis to .team-os/artifacts/findings/analyze/:
- Proposed note structure
- Tag recommendations
- Category placement
- Frontmatter templates
`;

const TEMPLATE_SPAWN_LINK_CURATOR = `# Link Curator Spawn Prompt

You are **link-curator**, a vault connection specialist.

## Mission
Find and recommend bidirectional links between new and existing notes for: **{{TOPIC}}**

## Method
1. For each new note, extract key concepts
2. Search vault for related existing notes
3. Score relevance (1-5)
4. Recommend [[wikilinks]] in both directions

## Output
Report to TEAM_BULLETIN.md:
- Link recommendations (relevance >= 3)
- Suggested wikilink text
- Bidirectional link pairs

## Rules
- READ ONLY - do not modify vault files
- Lead will apply the actual links
`;

const TEMPLATE_TEAM_PLAN = `# Team Plan

> Lead manages this file. Teammates reference it.

---

## Session

- **Subject**: (Lead fills in)
- **Complexity**: Simple / Standard / Complex
- **Started**: (auto)
- **Team**: (see table below)

---

## Team

| # | Teammate | Role | Model | Status |
|---|----------|------|-------|--------|

---

## Steps

| # | Step | Assignee | Dependency | Status |
|---|------|----------|------------|--------|
| 1 | | | - | pending |
| 2 | | | - | pending |
| 3 | | | Step 1 | pending |

---

## Constraints

- Lead only writes to vault (Task Agent write prohibition)
- Teammates are read-only (except content-analyzer: findings/analyze/)
- Findings go to TEAM_BULLETIN.md (append)
- Final results go to TEAM_FINDINGS.md
`;

const TEMPLATE_TEAM_BULLETIN = `# Team Bulletin (Append-Only)

> Real-time shared bulletin board for team findings.
> **Append-only**: never modify existing entries, always add below.
> TeammateIdle hook enforces updates to this file.

---

## Format

Each teammate appends in this format:

\`\`\`
## [YYYY-MM-DD HH:MM] - {agent_name}
**Task**: {what you did}
**Findings**: {key findings - concise}
**Links**: {related files/notes}
**Status**: {active|idle|completed}
\`\`\`

---

## Protocol

### Before work (required!)
1. Read this file -> check other teammates' recent findings
2. Read TEAM_PLAN.md -> confirm your assignment

### During work
3. Append important findings immediately
4. Reference other teammates' findings if relevant

### After work
5. Append final summary
6. Update TEAM_PROGRESS.md status

---

## Updates

(Teammate updates will be appended here)
`;

const TEMPLATE_TEAM_PROGRESS = `# Team Progress

> Track each teammate's current status.
> Teammates update their own row. Lead monitors overall.

---

## Status Board

| Teammate | Current Task | Progress | Last Update | Note |
|----------|-------------|----------|-------------|------|

---

## Checkpoints

| # | Checkpoint | Condition | Done |
|---|-----------|-----------|------|
| 1 | Graph search complete | graph-navigator + retrieval-specialist results received | [ ] |
| 2 | Cross-validation complete | Core notes list finalized | [ ] |
| 3 | Notes created | All notes saved to vault | [ ] |
| 4 | Links strengthened | Bidirectional links confirmed | [ ] |

---

## Blockers

| # | Reason | Affected | Resolution | Status |
|---|--------|----------|------------|--------|
`;

const TEMPLATE_TEAM_FINDINGS = `# Team Findings

> Consolidated findings after cross-validation.
> Lead records final results here after verifying teammate outputs.

---

## Session: (topic)

### Cross-Validation Summary

| Source | Found | Core | Isolated |
|--------|-------|------|----------|
| graph-navigator | | | |
| retrieval-specialist | | | |
| Both (cross-validated) | | | |

### Core Notes (cross-validated)

| # | Note Path | Relevance | Source |
|---|-----------|-----------|--------|

### Key Insights

1.
2.
3.

### Knowledge Gaps

- Uncovered areas:
- Open questions:
- Recommended further exploration:

---

## Agent Results

### @graph-navigator
- Hub notes:
- 1-hop connections:
- 2-hop discoveries:

### @retrieval-specialist
- Keyword matches:
- Tag matches:
- Folder distribution:

### @deep-reader (Complex only)
- Cross-analysis:
- Knowledge gaps:

### @content-analyzer (Complex only)
- Recommended structure:
- Tag recommendations:

### @link-curator (Complex only)
- Bidirectional link recommendations:
- Isolated note discoveries:
`;

const TEMPLATE_MEMORY = `# Team Memory (Cross-Session Persistent)

> Long-term memory that persists across sessions.
> Key findings from TEAM_FINDINGS.md are transferred here after each session.
> This is the ONLY file that survives session resets.

---

## Decisions

| # | Date | Decision | Reason | Session |
|---|------|----------|--------|---------|

## Assumptions

| # | Assumption | Verification | Status |
|---|-----------|-------------|--------|

## Lessons Learned

| # | Date | Lesson | Application |
|---|------|--------|------------|

## Session Log

| # | Date | Topic | Complexity | Notes | Links | Teammates |
|---|------|-------|-----------|-------|-------|-----------|

---

## Notes

- Archive old entries after 50+ sessions
- Keep only key decisions/lessons (Progressive Disclosure)
- Token budget: keep this file under 500 tokens
`;

const TEMPLATE_HOOK_IDLE = `#!/usr/bin/env node
/**
 * TeammateIdle Quality Gate
 * Ensures teammates update TEAM_BULLETIN.md before going idle.
 * exit 2 = block idle, exit 0 = allow idle
 */

const fs = require('fs');
const path = require('path');

async function main() {
  let input = '';
  for await (const chunk of process.stdin) { input += chunk; }

  let hookData;
  try { hookData = JSON.parse(input); } catch { process.exit(0); }

  const teammateName = hookData.teammate_name || 'unknown';
  const cwd = hookData.cwd || process.cwd();
  const bulletinPath = path.join(cwd, '.team-os', 'artifacts', 'TEAM_BULLETIN.md');

  if (!fs.existsSync(bulletinPath)) process.exit(0);

  const content = fs.readFileSync(bulletinPath, 'utf-8');
  const pattern = new RegExp(\`## \\\\[.*\\\\] - \${teammateName}\`, 'i');

  if (!pattern.test(content)) {
    process.stderr.write(
      \`[Quality Gate] \${teammateName}: Update TEAM_BULLETIN.md before going idle.\\n\`
    );
    process.exit(2);
  }

  process.exit(0);
}

main().catch(() => process.exit(0));
`;

const TEMPLATE_HOOK_COMPLETED = `#!/usr/bin/env node
/**
 * TaskCompleted Quality Gate
 * Checks that write-agents produced output files.
 * exit 2 = block completion, exit 0 = allow
 */

const fs = require('fs');
const path = require('path');

async function main() {
  let input = '';
  for await (const chunk of process.stdin) { input += chunk; }

  let hookData;
  try { hookData = JSON.parse(input); } catch { process.exit(0); }

  const teammateName = hookData.teammate_name || 'unknown';
  const cwd = hookData.cwd || process.cwd();

  const roleToDir = {
    'graph-navigator': 'graph',
    'retrieval-specialist': 'graph',
    'deep-reader': 'graph',
    'content-analyzer': 'analyze',
    'link-curator': 'storage'
  };

  const findingsDir = roleToDir[teammateName];
  if (!findingsDir) process.exit(0);

  // Only check write agents
  const writeAgents = ['content-analyzer'];
  if (!writeAgents.includes(teammateName)) process.exit(0);

  const findingsPath = path.join(cwd, '.team-os', 'artifacts', 'findings', findingsDir);
  if (!fs.existsSync(findingsPath)) {
    process.stderr.write(\`[Quality Gate] \${teammateName}: Output directory missing: \${findingsPath}\\n\`);
    process.exit(2);
  }

  const files = fs.readdirSync(findingsPath).filter(f => f !== '.gitkeep');
  if (files.length === 0) {
    process.stderr.write(\`[Quality Gate] \${teammateName}: No output files created.\\n\`);
    process.exit(2);
  }

  process.exit(0);
}

main().catch(() => process.exit(0));
`;

const TEMPLATE_CONSENSUS = `---
id: "CONS-{YYYY-MM-DD}-{NNN}"
status: proposed
proposer: "{teammate_name}"
created: "{YYYY-MM-DD}"
resolved: ""
---

# Consensus: {title}

## Proposal

{description}

## Reason

{why this change is needed}

## Impact

- Affected files: []
- Affected teams: []

## Discussion

### {teammate_name} | {timestamp}
{opinion}

## Decision

> {final decision - only when status=agreed}

## Tasks

- [ ] {implementation task 1}
- [ ] {implementation task 2}
`;

// === CLI entry point ===
if (require.main === module) {
  const projectRoot = path.resolve(__dirname, '..', '..');
  const repair = process.argv.includes('--repair');
  console.log(`Team OS Bootstrap${repair ? ' (repair mode)' : ''} — project root: ${projectRoot}`);
  const report = bootstrapTeamOS(projectRoot, { repair });
  if (report.created.length) {
    console.log(`\nCreated: ${report.created.length} files/dirs`);
    console.log(report.created.map(f => `  + ${f}`).join('\n'));
  }
  if (report.repaired.length) {
    console.log(`\nRepaired: ${report.repaired.length} missing files`);
    console.log(report.repaired.map(f => `  ~ ${f}`).join('\n'));
  }
  if (report.skipped.length) console.log(`\nSkipped: ${report.skipped.join(', ')}`);
  if (report.errors.length) console.log(`\nErrors: ${report.errors.join('\n')}`);
}

module.exports = { bootstrapTeamOS };
